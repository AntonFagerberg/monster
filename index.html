<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Phaser - Making your first game, part 1</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            background-color: #000;
        }

        canvas {
          margin: 0 auto;
        }
    </style>
</head>
<body>


<script type="text/javascript">

var game = new Phaser.Game(1024, 768, Phaser.AUTO, '', { preload: preload, create: create, update: update }),
  monster = (function () {
    return {
      state: [],
      tick: 0,
      tileSize: 64,
      active: false,
      clickMode: 0,
      mainTitle: null,
      round: 1,
      highscore: 0,
      coins: 100,
      stalkers: [],

      addSprite: function (name, x, y) {
        var sprite = game.add.sprite(x * this.tileSize, y * this.tileSize, name);
        sprite.scale.setTo(2, 2);
        sprite.smoothed = false;
        return sprite;
      },

      position: function (cord) {
        return cord * this.tileSize;
      },

      princess: (function () {
        var x = -1,
            y = -1,
            forward = true,
            sprite = null,
            prince = null,
            offset = 14,
            dead = false,
            stalkerUpdate = false;

        return {
          start: function () {
            x = 1 + parseInt(Math.random() * 10, 10),
            y = 3,
            forward = true;

            sprite.x = monster.position(x);
            sprite.y = monster.position(y) - offset;
            prince.x = monster.position(x);
            prince.y = monster.position(10) - offset;
            monster.mainTitle.text = '';

            game.world.bringToTop(sprite);
          },

          clear: function () {
            x = -10;
            y = -10;

            sprite.x = monster.position(x);
            sprite.y = monster.position(y) - offset;
            prince.x = monster.position(x);
            prince.y = monster.position(10) - offset;
          },

          update: function () {
            if (monster.active) {
              if (!forward && y == 3) {
                monster.mainTitle.text = "Princess defeated you!";
                monster.dark.visible = true;
                game.world.bringToTop(monster.dark);
                monster.roundTitle.text = 'Game Over!\nHighscore: ' + monster.highscore;
                game.world.bringToTop(monster.mainTitle);
                monster.active = false;
                monster.round = 1;
                monster.clickMode = 3;
              } else {
                if (Math.random() >= 0.40) {
                  if (forward) {
                    y += 1;

                    if (y == 10) {
                      forward = false;
                    }
                  } else {
                    y -= 1;
                  }
                } else {
                  if (x == 1 || (Math.random() >= 0.5 && x != 10)) {
                    x += 1;
                  } else {
                    x -= 1;
                  }
                }

                if (stalkerUpdate) {
                  (function () {
                    if (stalkerUpdate) {
                      for (var i = 0; i < monster.stalkers.length; i++) {
                        var moves = [];

                        var theStalker = monster.stalkers[i];
                        for (var xx = -1; xx <= 1; xx++) {
                          for (var yy = -1; yy <= 1; yy++) {
                            var iX = theStalker.xx + xx;
                            var iY = theStalker.yy + yy;

                            if (iX >= 0 && iY >= 0 && iX < 10 && iY < 6 && monster.state[iY][iX] == 0) {
                              moves.push({x: iX, y: iY});
                            }
                          }
                        }

                        if (moves.length) {
                          var theMove = moves[parseInt(Math.random() * moves.length, 10)];
                          monster.state[theStalker.yy][theStalker.xx] = 0;
                          theStalker.xx = theMove.x;
                          theStalker.yy = theMove.y;
                          theStalker.x = monster.position(theStalker.xx + 1);
                          theStalker.y = monster.position(theStalker.yy + 4);
                          monster.state[theMove.y][theMove.x] = theStalker;
                        }
                      }
                    }
                  })();
                }

                stalkerUpdate = !stalkerUpdate;

                sprite.x = monster.position(x);
                sprite.y = monster.position(y) - offset;

                prince.x = monster.position(x) + offset;
                if (!forward) {
                  prince.y = monster.position(y) - offset;
                }

                var positionX = x - 1,
                    positionY = y - 4;

                if (positionX >= 0 && positionY >= 0 && positionX < monster.state[0].length && positionY < monster.state.length) {
                  if (typeof(monster.state[positionY][positionX]) === 'object') {
                    // monster.dark.visible = true;
                    // game.world.bringToTop(monster.dark);
                    var key = monster.state[positionY][positionX].key

                    if (key == 'gold_monster') {
                      monster.coins += 3;
                      monster.coinText.text = '' + monster.coins;
                      monster.state[positionY][positionX].destroy();
                      monster.state[positionY][positionX] = 0;
                    } else {
                      if (key == 'stalker_monster') {
                        (function () {
                          var i = -1;
                          for (var x = 0; x < monster.stalkers.length; x++) {
                            if (monster.stalkers[x] == monster.state[positionY][positionX]) {
                              i = x;
                            }
                          }
                          monster.stalkers.splice(i, 1);
                        })();
                      }

                      monster.state[positionY][positionX].destroy();
                      monster.state[positionY][positionX] = 0;

                      if (key == 'hole_monster') {
                        (function () {
                          for (var x = -1; x <= 1; x++) {
                            for (var y = -1; y <= 1; y++) {
                              monster.state[positionY + y][positionX + x] = 0;
                            }
                          }
                        })();
                      }

                      game.world.bringToTop(monster.mainTitle);
                      monster.mainTitle.text = 'Nice!';
                      monster.active = false;
                      monster.clickMode = 4;
                      if (monster.round > monster.highscore) {
                        monster.highscore = monster.round;
                      }
                      monster.roundTitle.text = 'Round: ' + monster.round + '\nHighscore: ' + monster.highscore;
                      monster.round += 1;
                    }
                  }
                }
              }
            }
          },

          create: function () {
            sprite = monster.addSprite('princess', x, y)
            prince = monster.addSprite('prince', x, y)
          }
        };
      })()
    };
  })();

function preload() {
  game.load.image('ground_1', 'assets/ground_tile_1.png');
  game.load.image('ground_2', 'assets/ground_tile_2.png');
  game.load.image('hole_monster', 'assets/hålmonster.png');
  game.load.image('hole_monster_silhouette', 'assets/holemonster_silhouette.png');
  game.load.image('gold_monster', 'assets/goldmonster.png');
  game.load.image('gold_monster_silhouette', 'assets/goldmonster.png');
  game.load.image('stalker_monster', 'assets/förföljaren.png');
  game.load.image('stalker_monster_silhouette', 'assets/förföljaren.png');
  game.load.image('princess', 'assets/princess.png');
  game.load.image('prince', 'assets/prince.png');
  game.load.image('safe_top', 'assets/safe_tile_top.png');
  game.load.image('safe_bottom', 'assets/safe_tile_bottom.png');
  game.load.image('beach', 'assets/beach_tile.png');
  game.load.image('water', 'assets/water_tile.png');
  game.load.image('frame', 'assets/frame.png');
  game.load.image('edge', 'assets/edge.png');
  game.load.image('corner', 'assets/corner.png');
  game.load.image('dark', 'assets/dark.png');
  game.load.image('coin', 'assets/coin.png');
  game.load.bitmapFont('font', 'assets/font/font.png', 'assets/font/font.fnt');
  game.load.bitmapFont('font_win', 'assets/font_win/font.png', 'assets/font_win/font.fnt');
}

function create() {
  var x = 0,
      y = 0,
      ground = ['ground_1', 'ground_2'];

  for (y = 0; y < 6; y++) {
    for (x = 0; x < 10; x++) {
      if (x == 0) {
        monster.state[y] = [];
      }

      monster.state[y][x] = 0;
    }
  }

  for (x = 1; x < 11; x++) {
    monster.addSprite('water', x, 1);
    monster.addSprite('beach', x, 2);
    monster.addSprite('safe_top', x, 3);
    monster.addSprite('safe_bottom', x, 10);
    monster.addSprite('edge', x + 1, 0).angle = 90;
    monster.addSprite('edge', x, 12).angle = 270;
  }

  monster.addSprite('edge', 13, 0).angle = 90;
  monster.addSprite('edge', 14, 0).angle = 90;
  monster.addSprite('edge', 15, 0).angle = 90;

  monster.addSprite('edge', 12, 12).angle = 270;
  monster.addSprite('edge', 13, 12).angle = 270;
  monster.addSprite('edge', 14, 12).angle = 270;

  monster.addSprite('corner', 0, 0);
  monster.addSprite('corner', 12, 0).angle = 90;
  monster.addSprite('corner', 12, 12).angle = 180;
  monster.addSprite('corner', 0, 12).angle = 270;

  monster.addSprite('corner', 11, 0);
  monster.addSprite('corner', 16, 0).angle = 90;
  monster.addSprite('corner', 16, 12).angle = 180;
  monster.addSprite('corner', 11, 12).angle = 270;

  for (y = 1; y < 11; y++) {
    monster.addSprite('edge', 0, y);
    monster.addSprite('edge', 12, y + 1).angle = 180;

    monster.addSprite('edge', 11, y);
    monster.addSprite('edge', 16, y + 1).angle = 180;
  }

  for (x = 1; x < 11; x++) {
    for (y = 4; y < 10; y++) {
      monster.addSprite(ground[(y + x) % 2], x, y);
    }
  }

  monster.mainTitle = game.add.bitmapText(monster.position(1.8), monster.position(4.5), 'font_win', '', 48);

  game.add.bitmapText(monster.position(13), monster.position(1) + (monster.tileSize / 2) - 4, 'font', 'Start', 16);
  monster.roundTitle = game.add.bitmapText(monster.position(5), monster.position(11) + (monster.tileSize / 2) - 4, 'font', 'Round: 1\nHighscore: ' + monster.highscore, 16);

  monster.addSprite('hole_monster', 12, 8);
  monster.addSprite('stalker_monster', 13, 6);
  monster.addSprite('gold_monster', 13, 4);

  monster.cursor_stalker_monster = monster.addSprite('stalker_monster_silhouette', -1000, -1000);
  monster.cursor_hole_monster = monster.addSprite('hole_monster_silhouette', -1000, -1000);
  monster.cursor_gold_monster = monster.addSprite('gold_monster_silhouette', -1000, -1000);

  monster.princess.create();

  monster.dark = monster.addSprite('dark', 1, 1);
  monster.dark.scale.setTo(20,20)
  monster.dark.visible = false;

  var sprite = game.add.sprite(13 * monster.tileSize - 24, 2 * monster.tileSize, 'coin');
  sprite.scale.setTo(2, 2);
  sprite.smoothed = false;

  monster.coinText = game.add.bitmapText(monster.position(13) + 32, monster.position(2) + (monster.tileSize / 2) - 8, 'font', ''+monster.coins, 16);

  game.add.sprite(13 * monster.tileSize, 5 * monster.tileSize, 'coin');
  game.add.bitmapText(monster.position(13) + 32, monster.position(5) + 8, 'font', '1', 16);

  game.add.sprite(13 * monster.tileSize, 7 * monster.tileSize, 'coin');
  game.add.bitmapText(monster.position(13) + 32, monster.position(7) + 8, 'font', '5', 16);

  game.add.sprite(13 * monster.tileSize, 10 * monster.tileSize + 42, 'coin');
  game.add.bitmapText(monster.position(13) + 32, monster.position(10) + 50, 'font', '3', 16);
  //sprite.scale.setTo(2, 2);
  sprite.smoothed = false;

  game.input.onDown.add(function () {
    var clickX = parseInt(game.input.x / monster.tileSize, 10),
        clickY = parseInt(game.input.y / monster.tileSize, 10);

    console.log(clickX, clickY);

    for (var y = 0; y != monster.state.length; y++) {
      var line = "| ";
      for (var x = 0; x != monster.state[y].length; x++) {
        line = line + (typeof(monster.state[y][x]) == 'object' && monster.state[y][x].key || monster.state[y][x]) + " | ";
      }
      console.log(line + Math.random());
    }

    switch (monster.clickMode) {
      case 0:
        if (clickX == 13 && clickY == 1 && !monster.active) { // Start game
          monster.active = true;
          monster.princess.start();
          monster.roundTitle.text = 'Round: ' + monster.round + '\nHighscore: ' + monster.highscore;
        } else if (clickX == 13 && clickY == 6 && !monster.active) { // Stalker
          monster.clickMode = 2;
        } else if (!monster.active && clickX >= 12 && clickX <= 14 && clickY >= 8 && clickY <= 10) { // Holer
          monster.clickMode = 1;
        } else if (clickX == 13 && clickY == 4 && !monster.active) { // Golder
          monster.clickMode = 5;
        }

        break;

      case 1:
        if (clickX >= 2 && clickX <= 9 && clickY >= 5 && clickY <= 8 && monster.coins >= 3) {
          var free = true,
              positionX = clickX - 1,
              positionY = clickY - 4;

          console.log(positionX, positionY);

          for (var x = -1; x <= 1; x++) {
            for (var y = -1; y <= 1; y++) {
              if (monster.state[positionY + y][positionX + x] != 0) {
                free = false;
              }
            }
          }

          if (free) {
            monster.state[positionY][positionX] = monster.addSprite('hole_monster', clickX - 1, clickY - 1);
            monster.coins -= 3;
            monster.coinText.text = '' + monster.coins;
            monster.state[positionY - 1][positionX - 1] = 1;
            monster.state[positionY - 1][positionX] = 1;
            monster.state[positionY - 1][positionX + 1] = 1;
            monster.state[positionY][positionX - 1] = 1;
            monster.state[positionY][positionX + 1] = 1;
            monster.state[positionY + 1][positionX - 1] = 1;
            monster.state[positionY + 1][positionX] = 1;
            monster.state[positionY + 1][positionX + 1] = 1;
            // monster.clickMode = 0;
            // monster.cursor_hole_monster.x = -1000;
            // monster.cursor_hole_monster.y = -1000;
          }
        } else if (clickX < 1 || clickX > 10 || clickY < 1 || clickY > 10) {
          monster.clickMode = 0;
          monster.cursor_hole_monster.x = -1000;
          monster.cursor_hole_monster.y = -1000;
        }
        break;

      case 2:
        if (clickX >= 1 && clickX <= 10 && clickY >= 4 && clickY <= 9) {
          var positionX = clickX - 1,
              positionY = clickY - 4;

          if (monster.state[positionY][positionX] == 0 && monster.coins >= 5) {
            monster.coins -= 5;
            monster.coinText.text = '' + monster.coins;
            monster.state[positionY][positionX] = monster.addSprite('stalker_monster', clickX, clickY);
            monster.state[positionY][positionX].xx = positionX;
            monster.state[positionY][positionX].yy = positionY;
            monster.stalkers.push(monster.state[positionY][positionX]);
            // monster.clickMode = 0;
            // monster.cursor_stalker_monster.x = -1000;
            // monster.cursor_stalker_monster.y = -1000;
          }
        } else if (clickX < 1 || clickX > 10 || clickY < 1 || clickY > 10) {
          monster.clickMode = 0;
          monster.cursor_stalker_monster.x = -1000;
          monster.cursor_stalker_monster.y = -1000;
        }
        break;

      case 3:
        (function () {
          monster.stalkers = [];

          for (var y = 0; y < monster.state.length; y++) {
            for (var x = 0; x < monster.state[y].length; x++) {
              if (typeof(monster.state[y][x]) === 'object') {
                monster.state[y][x].destroy();
              }

              monster.state[y][x] = 0;
            }
          }
        })();
        monster.princess.clear();
        monster.clickMode = 0;
        monster.mainTitle.text = '';
        monster.roundTitle.text = 'Round: 1\nHighscore: ' + monster.highscore;
        monster.dark.visible = false;
        monster.coins = 25;
        monster.coinText.text = '25';
        break;

      case 4:
        monster.princess.clear();
        monster.clickMode = 0;
        monster.mainTitle.text = '';
        monster.dark.visible = false;
        break;

      case 5:
        if (clickX >= 1 && clickX <= 10 && clickY >= 4 && clickY <= 9) {
          var positionX = clickX - 1,
              positionY = clickY - 4;

          if (monster.state[positionY][positionX] == 0 && monster.coins >= 1) {
            monster.coins -= 1;
            monster.coinText.text = '' + monster.coins;
            monster.state[positionY][positionX] = monster.addSprite('gold_monster', clickX, clickY);
          }
        } else if (clickX < 1 || clickX > 10 || clickY < 1 || clickY > 10) {
          monster.clickMode = 0;
          monster.cursor_gold_monster.x = -1000;
          monster.cursor_gold_monster.y = -1000;
        }
        break;
    }
  }, this);
}

function update() {
  if (monster.active) {
    monster.tick += 1;

    if (monster.tick >= 30) {
      monster.princess.update();
      monster.tick = 0;
    }
  }

  if (monster.clickMode == 1) {
    monster.cursor_hole_monster.x = monster.tileSize * (parseInt(game.input.x / monster.tileSize, 10) - 1);
    monster.cursor_hole_monster.y = monster.tileSize * (parseInt(game.input.y / monster.tileSize, 10) - 1);
  } else if (monster.clickMode == 2) {
    monster.cursor_stalker_monster.x = monster.tileSize * parseInt(game.input.x / monster.tileSize, 10);
    monster.cursor_stalker_monster.y = monster.tileSize * parseInt(game.input.y / monster.tileSize, 10);
  } else if (monster.clickMode == 5) {
    monster.cursor_gold_monster.x = monster.tileSize * parseInt(game.input.x / monster.tileSize, 10);
    monster.cursor_gold_monster.y = monster.tileSize * parseInt(game.input.y / monster.tileSize, 10);
  }
}

</script>

</body>
</html>
